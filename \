import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { useTranslation } from "@/hooks/use-translation";
import { Alert, View} from "react-native";
import { PropsWithChildren, useState } from "react";
import { Button, ButtonProps } from "@/components/ui/button";
import { Target } from "lucide-react-native";
import { Text } from "@/components/ui/text";
import DateTimePicker from "@react-native-community/datetimepicker"
import { AddButton } from "@/components/shared/add-button";
import { useTaskStore } from "@/stores/use-task-store";
import { NewTask } from "@/database/types";
import { router } from "expo-router";
import { Form, FormField, FormInput, FormSubmit } from "@/components/shared/form";

const today = new Date();

type FieldProps = {
    name: string,
    label: string,
} & PropsWithChildren


const Field = ({ name, label, children }: FieldProps) => (
    <View className="flex w-full gap-2">
        <Label htmlFor={name} nativeID={name}>{label}</Label>
        {children}
    </View>
)


const DeadlinePicker = (props: Omit<ButtonProps, "onPress">) => {
    const [show, setShow] = useState<boolean>(false);
    const [date, setDate] = useState<Date>(today);

    return (
        <>
            <Button {...props} onPress={() => setShow(true)}>
                <Text>Select</Text>
                <Target />
            </Button>
            {show && (
                <DateTimePicker 
                    testID="deadlinePicker"
                    value={today}
                    mode="datetime"
                    is24Hour
                    onChange={(_, selectedDate) => {
                        setShow(false)
                        if (selectedDate) {
                            setDate(selectedDate)
                        }
                    }}

                />
            )}
        </>
    )

}

type CreateTaskForm = NonNullable<NewTask>
const defaultFormProps = {
    defaultValues: {
        name: "",
        description: ""
    }
}


export default function CreateTaskModal() {
    const { t } = useTranslation("modals.create-task")
    const createTask = useTaskStore(state => state.createTask)

    function handleCreateTask(data: CreateTaskForm) {
        if (!newTask) { 
            throw new Error("Can't create empty task!")
        }
        createTask(newTask)
        router.navigate("/todo")
    }

    return (
        <Form<CreateTaskForm> formProps={defaultFormProps} className="w-full h-full justify-between p-4">
            <View className="flex gap-4 flex-col">
                <FormField id="name" label="Name">
                    <FormInput placeholder="Name" rules={{ required: "Name is required" }} />
                </FormField>
            </View>

            <FormSubmit<CreateTaskForm> onSubmit={handleCreateTask} className="w-full">
                <AddButton className="mb-8" />
            </FormSubmit>
        </Form>
    )
}
